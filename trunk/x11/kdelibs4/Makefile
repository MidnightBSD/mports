# -*-mode: makefile-*-
#
# $MidnightBSD: mports/x11/kdelibs4/Makefile,v 1.1 2008/12/10 15:09:13 ctriv Exp $
#

PORTNAME=	kdelibs
PORTVERSION=	${KDE4_VERSION}
PORTREVISION=	1
CATEGORIES=	x11 kde ipv6
MASTER_SITES=	${MASTER_SITE_KDE}
MASTER_SITE_SUBDIR=	stable/${PORTVERSION}/src
PKGNAMESUFFIX?=	# empty
DIST_SUBDIR=	KDE

MAINTAINER=	ports@MidnightBSD.org
COMMENT=	Base set of libraries needed by KDE programs
LICENSE=	lgpl

LIB_DEPENDS=	searchclient:${PORTSDIR}/deskutils/strigi \
		soprano.4:${PORTSDIR}/textproc/soprano \
		IlmImf:${PORTSDIR}/graphics/OpenEXR \
		aspell:${PORTSDIR}/textproc/aspell \
		jasper:${PORTSDIR}/graphics/jasper \
		pcre:${PORTSDIR}/devel/pcre \
		avahi-core:${PORTSDIR}/net/avahi-app \
		enchant.1:${PORTSDIR}/textproc/enchant \
		ungif.5:${PORTSDIR}/graphics/libungif \
		png.5:${PORTSDIR}/graphics/png \
		jpeg:${PORTSDIR}/graphics/jpeg \
		idn:${PORTSDIR}/dns/libidn \
		hal.1:${PORTSDIR}/sysutils/hal \
		smbclient.0:${PORTSDIR}/net/samba-libsmbclient \
		phonon.4:${PORTSDIR}/multimedia/phonon
RUN_DEPENDS=	${LOCALBASE}/share/icons/hicolor/index.theme:${PORTSDIR}/misc/hicolor-icon-theme \
		update-mime-database:${PORTSDIR}/misc/shared-mime-info \
		iceauth:${PORTSDIR}/x11/iceauth \
		xauth:${PORTSDIR}/x11/xauth
# XXX: hebrew/hspell?
# XXX: gssapi/kerberos special handling?

.if exists(${LOCALBASE}/include/avahi-compat-libdns_sd/dns_sd.h) || defined(WITH_LIBDNS)
LIB_DEPENDS+=	avahi-qt4:${PORTSDIR}/net/avahi-qt4 \
		dns_sd:${PORTSDIR}/net/avahi-libdns
.else
LIB_DEPENDS+=	dns_sd:${PORTSDIR}/net/mDNSResponder
.endif

CONFLICTS=	qt4-phonon-4*
LATEST_LINK=	${PORTNAME}4

USE_KDE4=	kdeprefix kdehier automoc4 sharedmime
KDE4_BUILDENV=	yes
USE_BZIP2=	yes
USE_FAM=	yes
USE_GETTEXT=	yes
USE_OPENSSL=	yes
USE_QT_VER=	4
QT_COMPONENTS=	corelib dbus gui moc network opengl qmake qt3support \
		qtestlib rcc script sql svg uic3 xml designer \
		assistant svg qdbusviewer makeqpf imageformats
USE_GNOME=	libxml2 libxslt

MAN1=		checkXML.1 kde4-config.1 makekdewidgets.1 kdecmake.1
MAN7=		kdeoptions.7 qtoptions.7
MAN8=		kbuildsycoca4.8

post-extract:
	${MKDIR} ${WRKSRC}

post-patch:
#fix finding automoc when PREFIX is not matched KDE4_PREFIX
	${REINPLACE_CMD} -e 's|NO_DEFAULT_PATH|${KDE4_PREFIX} NO_DEFAULT_PATH|' \
		${WRKSRC}/../cmake/modules/FindAutomoc4.cmake

pre-configure:
	${REINPLACE_CMD} -e 's|<qdatetime.h>|<QDateTime>|'\
		${WRKSRC}/../kjs/api/kjsobject.cpp
#prevent updating mime during build
	${REINPLACE_CMD} -e '/^update_xdg_mimetypes/d; /SharedMimeInfo/d' \
		${WRKSRC}/../mimetypes/CMakeLists.txt
	${REINPLACE_CMD} -e 's|".kde"|".kde4"|' \
		${WRKSRC}/../CMakeLists.txt

.include <bsd.port.mk>
