#!/bin/sh
# $FreeBSD: ports/security/clamav/files/pkg-install.in,v 1.2 2006/08/08 19:33:04 garga Exp $

PREFIX=${PKG_PREFIX:-%%PREFIX%%}

CLAMAVUSER=%%CLAMAVUSER%%
CLAMAVGROUP=%%CLAMAVGROUP%%
UID=106
GID=$UID

DBDIR=%%DBDIR%%
LOGDIR=%%LOGDIR%%
RUNDIR=%%RUNDIR%%

if [ -n "%%DESTDIR%%" ]; then
	PW="/usr/sbin/chroot %%DESTDIR%% pw"
	CHOWN="/usr/sbin/chroot %%DESTDIR%% chown"
	MKDIR="/usr/sbin/chroot %%DESTDIR%% mkdir -p"
else
	PW="pw"
	CHOWN="chown"
	MKDIR="mkdir -p"
fi

if [ "$2" = "PRE-INSTALL" ]; then

	if ! ${PW} groupshow ${CLAMAVGROUP} 2>/dev/null 1>&2; then
		if ${PW} groupadd ${CLAMAVGROUP} -g $GID; then
			echo "=> Added group \"${CLAMAVGROUP}\"."
		else
			echo "=> Adding group \"${CLAMAVGROUP}\" failed..."
			exit 1
		fi
	fi

	if ! ${PW} usershow ${CLAMAVUSER} 2>/dev/null 1>&2; then
		if ${PW} useradd ${CLAMAVUSER} -u $UID -g ${CLAMAVGROUP} -h - \
			-s "/sbin/nologin" -d "/nonexistent" \
			-c "Clam Antivirus"; \
		then
			${PW} groupmod mail -m ${CLAMAVUSER}
			echo "=> Added user \"${CLAMAVUSER}\"."
		else
			echo "=> Adding user \"${CLAMAVUSER}\" failed..."
			exit 1
		fi
	fi

elif [ "$2" = "POST-INSTALL" ]; then

	if [ ! -d "${DESTDIR}${DBDIR}" ]; then
		${MKDIR} ${DBDIR} || exit 1
		${CHOWN} ${CLAMAVUSER}:${CLAMAVGROUP} ${DBDIR} || exit 1
	fi

	if [ ! -d "${DESTDIR}${LOGDIR}" ]; then
		${MKDIR} ${LOGDIR} || exit 1
		${CHOWN} ${CLAMAVUSER}:${CLAMAVGROUP} ${LOGDIR} || exit 1
	fi

	if [ ! -d "${DESTDIR}${RUNDIR}" ]; then
		${MKDIR} ${RUNDIR} || exit 1
		${CHOWN} ${CLAMAVUSER}:${CLAMAVGROUP} ${RUNDIR} || exit 1
	fi

	if [ -f "${TARGETDIR}/etc/clamav.conf" ]; then
		echo
		echo "**************** WARNING ****************"
		echo "*                                       *"
		echo "*  The configuration file has changed:  *"
		echo "* Please edit $PREFIX/etc/clamd.conf *"
		echo "* and remove $PREFIX/etc/clamav.conf *"
		echo "*                                       *"
		echo "**************** WARNING ****************"
		echo
	fi

fi

exit 0
