--- src/extra/gd/gd_gd.c	2010-12-06 14:56:06.000000000 +0000
+++ src/extra/gd/gd_gd.c	2010-12-06 14:57:04.000000000 +0000
@@ -42,6 +42,10 @@
 	    {
 	      goto fail1;
 	    }
+	  if (&im->colorsTotal > gdMaxColors)
+	    {
+	      goto fail1;
+	    }
 	}
       /* Int to accommodate truecolor single-color transparency */
       if (!gdGetInt (&im->transparent, in))
